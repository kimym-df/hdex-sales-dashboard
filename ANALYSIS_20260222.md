# HDEX 매출 대시보드 - 2/22 매장별 매출 불일치 분석 보고서

**분석일**: 2026-02-26  
**대상**: [HDEX 매출 분석 대시보드](https://kimym-df.github.io/hdex-sales-dashboard/) 2/22 매장별 매출액 불일치 이슈

---

## 1. 데이터 흐름 요약

### 1.1 데이터 소스
- **2025년**: 엑셀 확정 데이터 (`HDEX_SALES_2025`) - 매장별 월별 매출
- **2026년**: Supabase `sales_online` 테이블 - `sale_date`, `store_name`, `actual_sale_amount`

### 1.2 매출 계산 공통 로직
1. Supabase에서 원시 데이터 조회
2. 매장+일자(또는 월) 단위로 `actual_sale_amount` 합산
3. **매장별 보정비율(storeCalibration)** 적용: `Math.round(합계 × ratio)`
4. 화면 표시

---

## 2. 2/22 불일치 원인 후보 (우선순위)

### 2.1 【높음】보정비율(Calibration) 적용 시점 문제

**현상**: `learnCalibration()`이 **2025년 선택 시에만** 호출됨.

```javascript
// loadSalesData() 내부 - 1388~1395행
if (periodVal === '2025') {
    learnCalibration(null, null).catch(...);  // ← 2025일 때만!
    ...
} else {
    // 2026: 보정비율 학습 없이 바로 storeCalibration 사용
}
```

- **기본 탭**: 매출 분석, **기본 기간**: 2026년
- **결과**: 사용자가 2025를 한 번도 선택하지 않으면 `storeCalibration`은 `{}` → 모든 비율 = 1 (보정 없음)
- **2025를 먼저 본 경우**: 2025 엑셀/Supabase 비율로 2026·일별 매출에 보정 적용
- **영향**: 동일 2/22 데이터라도, 2025를 먼저 봤는지 여부에 따라 화면 금액이 달라짐

**권장 수정**: 페이지 로드 시 2026이든 2025든 상관없이 `learnCalibration`을 먼저 실행하거나, 2026 로드 시에도 보정비율이 준비되어 있도록 초기화 순서를 변경.

---

### 2.2 【높음】매장 목록 불일치 (DAILY vs 월별)

| 구분 | 매장 수 | 포함 매장 | 비고 |
|------|--------|----------|------|
| **매출 분석 2026** | 19개 | 스타필드 수원 포함 | `storeFilterParam2026`, `HDEX_STORE_NAMES_2026` |
| **일별 매출** | 18개 | 스타필드 수원 **미포함** | `DAILY_STORE_ORDER` |

- 일별 탭은 `DAILY_STORE_ORDER`만 조회 → **스타필드 수원 데이터는 아예 포함되지 않음**
- 스타필드 수원은 2026-04 개점 예정이므로 2/22에는 실제 매출 없을 가능성 큼
- 단, 매출 분석 2026-02 월합계와 일별 2월 일별 합계를 비교할 때, 향후 스타필드 수원 데이터가 들어오면 **합계가 맞지 않을 수 있음**

**권장 수정**: `DAILY_STORE_ORDER`에 `스타필드 수원` 추가하여 두 탭의 매장 목록을 통일.

---

### 2.3 【중간】2025 기반 보정비율을 2026에 적용하는 적정성

- 보정비율: `엑셀확정 연간합계 / Supabase 연간합계` (매장별)
- 2025년 데이터로 학습 → 2026년 일별/월별 매출에 그대로 적용
- 2025와 2026의 매장·시즌·프로모션 구조가 다르면, 같은 비율을 2026에 쓰는 것이 부적절할 수 있음
- 결과: 2/22 같은 특정 일자의 매장별 금액이 다른 시스템(엑셀·POS 등)과 어긋날 수 있음

**권장**: 2026 전용 보정 로직 검토 또는, 보정 적용 여부를 설정으로 켜/끄기.

---

### 2.4 【중간】Supabase 매장명과 대시보드 매장명 매칭

- `store_name`이 Supabase와 **완전 일치**해야 집계됨
- 공백·띄어쓰기·특수문자 차이 시 해당 로우는 무시

```javascript
// aggregateDaily() - 2236행
if (!DAILY_STORE_ORDER.includes(store)) return;  // 매장명 불일치 시 제외
```

- 예: Supabase에 `"HDEX한남우먼"`으로 저장되어 있고 `DAILY_STORE_ORDER`는 `"HDEX 한남 우먼"`이면 해당 매장은 집계에서 제외됨

**권장**: Supabase `sales_online`의 `store_name` 고유값 목록을 조회해 `DAILY_STORE_ORDER`와 1:1 매칭 여부 확인.

---

### 2.5 【낮음】일별 합계 vs 매장별 합계 검증

- `renderDailyTable()` 내부에서:
  - 각 날짜 행합계 = `rowTotal = Σ(매장별 값)`
  - 각 매장 열합계 = `colTotal = Σ(일별 값)`
- 코드상으로는 수학적으로 일관되게 계산됨 (동일 `dailyMap` 사용)
- 따라서 **화면 내부**에서는 날짜 행합계와 매장 열합계 간의 불일치는 예상되지 않음

---

## 3. 검증 방법 제안

### 3.1 브라우저 콘솔로 확인
1. 대시보드 접속 후 개발자 도구(F12) → Console
2. 다음 값 확인:
   ```javascript
   storeCalibration   // 보정비율 맵 (비어 있으면 보정 미적용)
   dailyRawRows       // 일별 원시 데이터
   dailyRawRows._dailyMap  // 보정 적용 후 date|store → 금액 맵
   ```
3. 2/22 데이터:
   ```javascript
   Object.entries(dailyRawRows._dailyMap)
     .filter(([k]) => k.startsWith('2026-02-22'))
   ```

### 3.2 Supabase 원시 데이터 확인
- Supabase 대시보드 또는 SQL로 다음 쿼리 실행:
  ```sql
  SELECT sale_date, store_name, actual_sale_amount
  FROM sales_online
  WHERE sale_date = '2026-02-22'
  ORDER BY store_name;
  ```
- 매장별 `actual_sale_amount` 합계와 대시보드 표시값 비교

### 3.3 매출 분석 vs 일별 매출 상호 검증
- 매출 분석 탭: 2026년 2월, 매장별 월 매출
- 일별 매출 탭: 2/1 ~ 2/29(또는 2/22까지) 해당 매장 열의 합계
- 두 값이 동일해야 함 (같은 소스·같은 보정 적용 시)

---

## 4. 코드 수정 제안 (요약)

| 항목 | 수정 위치 | 제안 내용 |
|------|----------|----------|
| 보정비율 학습 타이밍 | `loadSalesData()` | 2026 로드 시에도 `learnCalibration` 선행 호출, 또는 페이지 초기화 시 한 번 학습 |
| 매장 목록 통일 | `DAILY_STORE_ORDER` | `스타필드 수원` 추가 |
| 디버깅 편의 | 전역 | `storeCalibration`·보정 적용 여부를 UI 또는 콘솔에 출력 옵션 추가 |

---

## 5. 정리

2/22 매장별 매출 불일치의 가능성 높은 원인은 다음 세 가지입니다.

1. **보정비율 적용 시점**: 2025를 먼저 봤는지 여부에 따라 화면 금액이 달라짐  
2. **매장 목록 차이**: 일별 탭에 스타필드 수원 미포함으로, 월별·일별 합계가 어긋날 수 있음  
3. **2025 기반 보정의 2026 적용**: 보정 방식 자체가 2/22 특정 일자에서 다른 시스템과 차이를 만들 수 있음  

추가로, Supabase `store_name`과 대시보드 매장명이 정확히 일치하는지 검증하는 것이 좋습니다.
